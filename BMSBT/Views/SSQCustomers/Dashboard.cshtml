@{
    ViewData["Title"] = "Customers Dashboard";
    Layout = "_LayoutCustomers";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-chart-pie"></i> @ViewData["Title"]
            </h4>
        </div>

        <div class="card-body">
            @if (ViewBag.ErrorMessage != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @ViewBag.ErrorMessage
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            }

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-8">
                                    <h5 class="card-title">Total Customers</h5>
                                    <h2 class="card-text display-4" id="totalCustomers">
                                        @(ViewBag.TotalAllCustomers?.ToString() ?? "0")
                                    </h2>
                                </div>
                                <div class="col-4 text-right">
                                    <i class="fas fa-users fa-4x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-8">
                                    <h5 class="card-title">Total Projects</h5>
                                    <h2 class="card-text display-4" id="totalProjects">
                                        @(ViewBag.Projects?.Count ?? 0)
                                    </h2>
                                </div>
                                <div class="col-4 text-right">
                                    <i class="fas fa-building fa-4x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-8">
                                    <h5 class="card-title">Total Blocks</h5>
                                    <h2 class="card-text display-4" id="totalBlocks">
                                        @(ViewBag.Blocks?.Count ?? 0)
                                    </h2>
                                </div>
                                <div class="col-4 text-right">
                                    <i class="fas fa-th-large fa-4x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Statistics -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <button id="getCombinedStatsBtn" class="btn btn-primary btn-block">
                        <i class="fas fa-chart-bar"></i> Show Top 5 Projects & Blocks Statistics
                    </button>
                </div>
            </div>

            <!-- Selection Section -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-building"></i> Select Project
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="projectSelect">Select Project:</label>
                                <select id="projectSelect" class="form-control">
                                    <option value="">-- Select a Project --</option>
                                    @if (ViewBag.Projects != null)
                                    {
                                        foreach (var project in ViewBag.Projects)
                                        {
                                            <option value="@project">@project</option>
                                        }
                                    }
                                </select>
                            </div>
                            <button id="getAllProjectsBtn" class="btn btn-info btn-block">
                                <i class="fas fa-list"></i> Show All Projects Statistics
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-th-large"></i> Select Block
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="blockSelect">Select Block:</label>
                                <select id="blockSelect" class="form-control">
                                    <option value="">-- Select a Block --</option>
                                    <optgroup label="Mohlanwal Blocks">
                                        @if (ViewBag.MohlanwalBlocks != null)
                                        {
                                            foreach (var block in ViewBag.MohlanwalBlocks)
                                            {
                                                <option value="@block" data-type="mohlanwal">@block</option>
                                            }
                                        }
                                    </optgroup>
                                    <optgroup label="Orchards Blocks">
                                        @if (ViewBag.OrchardsBlocks != null)
                                        {
                                            foreach (var block in ViewBag.OrchardsBlocks)
                                            {
                                                <option value="@block" data-type="orchards">@block</option>
                                            }
                                        }
                                    </optgroup>
                                </select>
                            </div>

                            <!-- Quick Block Buttons -->
                            <!-- Quick Block Buttons -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Quick Mohlanwal:</label>
                                        <div class="btn-group-vertical w-100" role="group">
                                            @{
                                                var mohlanwalBlocks = ViewBag.MohlanwalBlocks as List<string>;
                                                if (mohlanwalBlocks != null && mohlanwalBlocks.Any())
                                                {
                                                    foreach (var block in mohlanwalBlocks.Take(3))
                                                    {
                                                        <button type="button" class="btn btn-outline-info btn-sm mb-1 block-quick-btn"
                                                                data-block="@block" data-type="mohlanwal">
                                                            <i class="fas fa-cube"></i> @block
                                                        </button>
                                                    }
                                                }
                                                else
                                                {
                                                    <p class="text-muted small">No Mohlanwal blocks available</p>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Quick Orchards:</label>
                                        <div class="btn-group-vertical w-100" role="group">
                                            @{
                                                var orchardsBlocks = ViewBag.OrchardsBlocks as List<string>;
                                                if (orchardsBlocks != null && orchardsBlocks.Any())
                                                {
                                                    foreach (var block in orchardsBlocks.Take(3))
                                                    {
                                                        <button type="button" class="btn btn-outline-success btn-sm mb-1 block-quick-btn"
                                                                data-block="@block" data-type="orchards">
                                                            <i class="fas fa-leaf"></i> @block
                                                        </button>
                                                    }
                                                }
                                                else
                                                {
                                                    <p class="text-muted small">No Orchards blocks available</p>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button id="getAllBlocksBtn" class="btn btn-warning btn-block">
                                <i class="fas fa-list"></i> Show All Blocks Statistics
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p>Loading data...</p>
            </div>

            <!-- Results Display -->
            <div id="resultSection" class="mt-4" style="display: none;">
                <div class="card bg-light">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line"></i> Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>

            <!-- Statistics Tables -->
            <div class="row mt-4">
                <!-- Projects Statistics Table -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-building"></i> Projects Statistics
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-bordered" id="projectsTable">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>#</th>
                                            <th>Project Name</th>
                                            <th>Customers</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            var projectStats = ViewBag.ProjectStatistics as List<BMSBT.ViewModels.ProjectStatisticsViewModel>;
                                            var totalAll = ViewBag.TotalAllCustomers ?? 0;
                                            var projectIndex = 1;
                                        }

                                        @if (projectStats != null && projectStats.Any())
                                        {
                                            foreach (var stat in projectStats)
                                            {
                                                var percentage = totalAll > 0 ?
                                                Math.Round((stat.TotalCustomers * 100.0) / totalAll, 2) : 0;

                                                <tr>
                                                    <td>@projectIndex</td>
                                                    <td>
                                                        <button class="btn btn-link p-0 view-project-btn"
                                                                data-project="@stat.ProjectName"
                                                                style="text-decoration: none;">
                                                            <i class="fas fa-eye text-info"></i> @stat.ProjectName
                                                        </button>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-primary badge-pill">
                                                            @stat.TotalCustomers
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="progress" style="height: 20px;">
                                                            <div class="progress-bar bg-info"
                                                                 role="progressbar"
                                                                 style="width: @percentage%"
                                                                 aria-valuenow="@percentage"
                                                                 aria-valuemin="0"
                                                                 aria-valuemax="100">
                                                                @percentage%
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                projectIndex++;
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="4" class="text-center">No project statistics available</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Blocks Statistics Table -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-th-large"></i> Blocks Statistics
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-bordered" id="blocksTable">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>#</th>
                                            <th>Block Name</th>
                                            <th>Type</th>
                                            <th>Customers</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            var blockStats = ViewBag.BlockStatistics as List<BMSBT.ViewModels.BlockStatisticsViewModel>;
                                            var blockIndex = 1;
                                        }

                                        @if (blockStats != null && blockStats.Any())
                                        {
                                            foreach (var stat in blockStats)
                                            {
                                                var percentage = totalAll > 0 ?
                                                Math.Round((stat.TotalCustomers * 100.0) / totalAll, 2) : 0;

                                                // Determine block type
                                                // Determine block type
                                                var blockType = "Unknown";
                                                var typeBadgeClass = "badge-secondary";
                                                var typeIcon = "fas fa-question";

                                                var mohlanwalBlocksList = ViewBag.MohlanwalBlocks as List<string>;
                                                var orchardsBlocksList = ViewBag.OrchardsBlocks as List<string>;

                                                if (mohlanwalBlocksList != null && mohlanwalBlocksList.Contains(stat.BlockName))
                                                {
                                                    blockType = "Mohlanwal";
                                                    typeBadgeClass = "badge-info";
                                                    typeIcon = "fas fa-cube";
                                                }
                                                else if (orchardsBlocksList != null && orchardsBlocksList.Contains(stat.BlockName))
                                                {
                                                    blockType = "Orchards";
                                                    typeBadgeClass = "badge-success";
                                                    typeIcon = "fas fa-leaf";
                                                }

                                                <tr>
                                                    <td>@blockIndex</td>
                                                    <td>
                                                        <button class="btn btn-link p-0 view-block-btn"
                                                                data-block="@stat.BlockName"
                                                                style="text-decoration: none;">
                                                            <i class="fas fa-eye text-warning"></i> @stat.BlockName
                                                        </button>
                                                    </td>
                                                    <td>
                                                        <span class="badge @typeBadgeClass">
                                                            <i class="@typeIcon"></i> @blockType
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-warning badge-pill">
                                                            @stat.TotalCustomers
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="progress" style="height: 20px;">
                                                            <div class="progress-bar bg-warning"
                                                                 role="progressbar"
                                                                 style="width: @percentage%"
                                                                 aria-valuenow="@percentage"
                                                                 aria-valuemin="0"
                                                                 aria-valuemax="100">
                                                                @percentage%
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                blockIndex++;
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="5" class="text-center">No block statistics available</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Project Details -->
<div class="modal fade" id="projectDetailsModal" tabindex="-1" role="dialog" aria-labelledby="projectDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="projectDetailsModalLabel">
                    <i class="fas fa-building"></i> Project Details
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="projectModalLoading" class="text-center">
                    <div class="spinner-border text-info" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Loading project details...</p>
                </div>
                <div id="projectModalContent" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <a href="#" id="viewAllProjectCustomersLink" class="btn btn-info" style="display: none;">
                    <i class="fas fa-users"></i> View All Customers
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Block Details -->
<div class="modal fade" id="blockDetailsModal" tabindex="-1" role="dialog" aria-labelledby="blockDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="blockDetailsModalLabel">
                    <i class="fas fa-th-large"></i> Block Details
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="blockModalLoading" class="text-center">
                    <div class="spinner-border text-warning" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Loading block details...</p>
                </div>
                <div id="blockModalContent" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <a href="#" id="viewAllBlockCustomersLink" class="btn btn-warning" style="display: none;">
                    <i class="fas fa-users"></i> View All Customers
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Handle project selection change
            $('#projectSelect').change(function() {
                var projectName = $(this).val();

                if (!projectName) {
                    $('#resultSection').hide();
                    return;
                }

                showProjectDetails(projectName, true);
            });

            // Handle block selection change
            $('#blockSelect').change(function() {
                var blockName = $(this).val();

                if (!blockName) {
                    $('#resultSection').hide();
                    return;
                }

                showBlockDetails(blockName, true);
            });

            // Handle quick block buttons
            $(document).on('click', '.block-quick-btn', function() {
                var blockName = $(this).data('block');

                if (!blockName) return;

                // Set the dropdown value
                $('#blockSelect').val(blockName);

                // Show block details
                showBlockDetails(blockName, true);
            });

            // Handle "Show All Projects Statistics" button
            $('#getAllProjectsBtn').click(function() {
                showAllProjectsStatistics();
            });

            // Handle "Show All Blocks Statistics" button
            $('#getAllBlocksBtn').click(function() {
                showAllBlocksStatistics();
            });

            // Handle "Show Combined Statistics" button
            $('#getCombinedStatsBtn').click(function() {
                showCombinedStatistics();
            });

            // Handle View Project button in table
            $(document).on('click', '.view-project-btn', function() {
                var projectName = $(this).data('project');
                if (!projectName) return;
                showProjectModal(projectName);
            });

            // Handle View Block button in table
            $(document).on('click', '.view-block-btn', function() {
                var blockName = $(this).data('block');
                if (!blockName) return;
                showBlockModal(blockName);
            });

            // Function to show project details
            function showProjectDetails(projectName, showInSection = true) {
                if (showInSection) {
                    $('#loadingSpinner').show();
                    $('#resultSection').hide();
                }

                $.ajax({
                    url: '@Url.Action("GetCustomersByProject", "SSQCustomers")',
                    type: 'GET',
                    data: { projectName: projectName },
                    success: function(response) {
                        if (showInSection) {
                            $('#loadingSpinner').hide();
                            displayProjectResults(response, showInSection);
                        } else {
                            displayProjectResults(response, showInSection);
                        }
                    },
                    error: function(xhr, status, error) {
                        if (showInSection) {
                            $('#loadingSpinner').hide();
                            $('#resultContent').html(`
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i> An error occurred: ${error}
                                </div>
                            `);
                            $('#resultSection').show();
                        }
                    }
                });
            }

            // Function to show block details
            function showBlockDetails(blockName, showInSection = true) {
                if (showInSection) {
                    $('#loadingSpinner').show();
                    $('#resultSection').hide();
                }

                $.ajax({
                    url: '@Url.Action("GetCustomersByBlock", "SSQCustomers")',
                    type: 'GET',
                    data: { blockName: blockName },
                    success: function(response) {
                        if (showInSection) {
                            $('#loadingSpinner').hide();
                            displayBlockResults(response, showInSection);
                        } else {
                            displayBlockResults(response, showInSection);
                        }
                    },
                    error: function(xhr, status, error) {
                        if (showInSection) {
                            $('#loadingSpinner').hide();
                            $('#resultContent').html(`
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i> An error occurred: ${error}
                                </div>
                            `);
                            $('#resultSection').show();
                        }
                    }
                });
            }

            // Function to display project results
            function displayProjectResults(response, showInSection = true) {
                if (response.success) {
                    var html = `
                        <div class="alert alert-info">
                            <h4><i class="fas fa-building"></i> ${response.projectName}</h4>
                            <hr>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card bg-info text-white mb-3">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Total Customers</h5>
                                            <h1 class="display-4">${response.totalCustomers}</h1>
                                            <p class="card-text">${response.message}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="fas fa-users"></i> Sample Customers (First 5)</h5>
                                        </div>
                                        <div class="card-body">
                    `;

                    if (response.sampleData && response.sampleData.length > 0) {
                        html += `<ul class="list-group">`;
                        response.sampleData.forEach(function(customer, index) {
                            html += `
                                <li class="list-group-item">
                                    <strong>${customer.customerNo}</strong> - ${customer.customerName}
                                    <br>
                                    <small class="text-muted">
                                        Block: ${customer.block || 'N/A'},
                                        Sector: ${customer.sector || 'N/A'},
                                        Plot: ${customer.ploNo || 'N/A'},
                                        City: ${customer.city || 'N/A'}
                                    </small>
                                </li>
                            `;
                        });
                        html += `</ul>`;
                    } else {
                        html += `<p class="text-muted">No customer data available</p>`;
                    }

                    html += `
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <a href="@Url.Action("Index", "SSQCustomers")?searchString=${encodeURIComponent(response.projectName)}"
                                   class="btn btn-info">
                                    <i class="fas fa-search"></i> View All Customers for ${response.projectName}
                                </a>
                            </div>
                        </div>
                    `;

                    if (showInSection) {
                        $('#resultContent').html(html);
                        $('#resultSection').show();
                    }
                    return html;
                } else {
                    var errorHtml = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> ${response.message}
                        </div>
                    `;
                    if (showInSection) {
                        $('#resultContent').html(errorHtml);
                        $('#resultSection').show();
                    }
                    return errorHtml;
                }
            }

            // Function to display block results
            function displayBlockResults(response, showInSection = true) {
                if (response.success) {
                    var html = `
                        <div class="alert alert-warning">
                            <h4><i class="fas fa-th-large"></i> Block: ${response.blockName}</h4>
                            <hr>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card bg-warning text-white mb-3">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Total Customers</h5>
                                            <h1 class="display-4">${response.totalCustomers}</h1>
                                            <p class="card-text">${response.message}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                    `;

                    // Add breakdown by project if available
                    if (response.breakdownByProject && response.breakdownByProject.length > 0) {
                        html += `
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-building"></i> Projects in this Block</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group">
                        `;
                        response.breakdownByProject.forEach(function(project) {
                            html += `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${project.projectName || 'N/A'}
                                    <span class="badge badge-primary badge-pill">${project.customerCount}</span>
                                </li>
                            `;
                        });
                        html += `
                                    </ul>
                                </div>
                            </div>
                        `;
                    }

                    // Add sample customers
                    html += `
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="fas fa-users"></i> Sample Customers (First 5)</h5>
                                        </div>
                                        <div class="card-body">
                    `;

                    if (response.sampleData && response.sampleData.length > 0) {
                        html += `<ul class="list-group">`;
                        response.sampleData.forEach(function(customer, index) {
                            html += `
                                <li class="list-group-item">
                                    <strong>${customer.customerNo}</strong> - ${customer.customerName}
                                    <br>
                                    <small class="text-muted">
                                        Project: ${customer.project || 'N/A'},
                                        Sector: ${customer.sector || 'N/A'},
                                        Plot: ${customer.ploNo || 'N/A'},
                                        City: ${customer.city || 'N/A'}
                                    </small>
                                </li>
                            `;
                        });
                        html += `</ul>`;
                    } else {
                        html += `<p class="text-muted">No customer data available</p>`;
                    }

                    html += `
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <a href="@Url.Action("Index", "SSQCustomers")?searchString=${encodeURIComponent(response.blockName)}"
                                   class="btn btn-warning">
                                    <i class="fas fa-search"></i> View All Customers in Block ${response.blockName}
                                </a>
                            </div>
                        </div>
                    `;

                    if (showInSection) {
                        $('#resultContent').html(html);
                        $('#resultSection').show();
                    }
                    return html;
                } else {
                    var errorHtml = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> ${response.message}
                        </div>
                    `;
                    if (showInSection) {
                        $('#resultContent').html(errorHtml);
                        $('#resultSection').show();
                    }
                    return errorHtml;
                }
            }

            // Function to show all projects statistics
            function showAllProjectsStatistics() {
                $('#loadingSpinner').show();
                $('#resultSection').hide();

                $.ajax({
                    url: '@Url.Action("GetAllProjectsStatistics", "SSQCustomers")',
                    type: 'GET',
                    success: function(response) {
                        $('#loadingSpinner').hide();

                        if (response.success) {
                            var html = `
                                <div class="alert alert-info">
                                    <h4><i class="fas fa-chart-bar"></i> All Projects Statistics</h4>
                                    <hr>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Project Name</th>
                                                    <th>Total Customers</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                            `;

                            var totalAll = 0;
                            response.statistics.forEach(function(stat, index) {
                                html += `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${stat.projectName}</td>
                                        <td><span class="badge badge-info badge-pill">${stat.totalCustomers}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info view-project-btn"
                                                    data-project="${stat.projectName}">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </td>
                                    </tr>
                                `;
                                totalAll += stat.totalCustomers;
                            });

                            html += `
                                            </tbody>
                                            <tfoot class="bg-light">
                                                <tr>
                                                    <td colspan="2" class="text-right"><strong>Grand Total:</strong></td>
                                                    <td><strong>${totalAll}</strong></td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            `;

                            $('#resultContent').html(html);
                            $('#resultSection').show();
                        } else {
                            $('#resultContent').html(`
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i> ${response.message}
                                </div>
                            `);
                            $('#resultSection').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#loadingSpinner').hide();
                        $('#resultContent').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> An error occurred: ${error}
                            </div>
                        `);
                        $('#resultSection').show();
                    }
                });
            }

            // Function to show all blocks statistics with grouped view
            function showAllBlocksStatistics() {
                $('#loadingSpinner').show();
                $('#resultSection').hide();

                $.ajax({
                    url: '@Url.Action("GetAllBlocksStatistics", "SSQCustomers")',
                    type: 'GET',
                    success: function(response) {
                        $('#loadingSpinner').hide();

                        if (response.success) {
                            var html = `
                                <div class="alert alert-warning">
                                    <h4><i class="fas fa-chart-bar"></i> All Blocks Statistics</h4>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-header bg-info text-white">
                                                    <h5 class="mb-0"><i class="fas fa-cube"></i> Mohlanwal Blocks</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Block</th>
                                                                    <th>Customers</th>
                                                                    <th>Action</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                            `;

                            // Filter Mohlanwal blocks
                            var mohlanwalStats = response.statistics.filter(function(stat) {
                                return stat.blockType === "Mohlanwal";
                            });

                            mohlanwalStats.forEach(function(stat) {
                                html += `
                                    <tr>
                                        <td>${stat.blockName}</td>
                                        <td><span class="badge badge-info badge-pill">${stat.totalCustomers}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info view-block-btn"
                                                    data-block="${stat.blockName}">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });

                            if (mohlanwalStats.length === 0) {
                                html += `
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">No Mohlanwal blocks found</td>
                                    </tr>
                                `;
                            }

                            html += `
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header bg-success text-white">
                                                    <h5 class="mb-0"><i class="fas fa-leaf"></i> Orchards Blocks</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Block</th>
                                                                    <th>Customers</th>
                                                                    <th>Action</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                            `;

                            // Filter Orchards blocks
                            var orchardsStats = response.statistics.filter(function(stat) {
                                return stat.blockType === "Orchards";
                            });

                            orchardsStats.forEach(function(stat) {
                                html += `
                                    <tr>
                                        <td>${stat.blockName}</td>
                                        <td><span class="badge badge-success badge-pill">${stat.totalCustomers}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-success view-block-btn"
                                                    data-block="${stat.blockName}">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });

                            if (orchardsStats.length === 0) {
                                html += `
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">No Orchards blocks found</td>
                                    </tr>
                                `;
                            }

                            html += `
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            $('#resultContent').html(html);
                            $('#resultSection').show();
                        } else {
                            $('#resultContent').html(`
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i> ${response.message}
                                </div>
                            `);
                            $('#resultSection').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#loadingSpinner').hide();
                        $('#resultContent').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> An error occurred: ${error}
                            </div>
                        `);
                        $('#resultSection').show();
                    }
                });
            }

            // Function to show combined statistics
            function showCombinedStatistics() {
                $('#loadingSpinner').show();
                $('#resultSection').hide();

                $.ajax({
                    url: '@Url.Action("GetCombinedStatistics", "SSQCustomers")',
                    type: 'GET',
                    success: function(response) {
                        $('#loadingSpinner').hide();

                        if (response.success) {
                            var html = `
                                <div class="alert alert-primary">
                                    <h4><i class="fas fa-chart-pie"></i> Top 5 Statistics</h4>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header bg-info text-white">
                                                    <h5 class="mb-0"><i class="fas fa-building"></i> Top 5 Projects</h5>
                                                </div>
                                                <div class="card-body">
                                                    <ul class="list-group">
                            `;

                            response.topProjects.forEach(function(project, index) {
                                html += `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${project.name || 'N/A'}
                                        <div>
                                            <span class="badge badge-info badge-pill mr-2">${project.count}</span>
                                            <span class="badge badge-light">${project.percentage.toFixed(2)}%</span>
                                        </div>
                                    </li>
                                `;
                            });

                            html += `
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header bg-warning text-white">
                                                    <h5 class="mb-0"><i class="fas fa-th-large"></i> Top 5 Blocks</h5>
                                                </div>
                                                <div class="card-body">
                                                    <ul class="list-group">
                            `;

                            response.topBlocks.forEach(function(block, index) {
                                html += `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${block.name || 'N/A'}
                                        <div>
                                            <span class="badge badge-warning badge-pill mr-2">${block.count}</span>
                                            <span class="badge badge-light">${block.percentage.toFixed(2)}%</span>
                                        </div>
                                    </li>
                                `;
                            });

                            html += `
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <p class="lead">Total Customers: <strong>${response.totalCustomers}</strong></p>
                                    </div>
                                </div>
                            `;

                            $('#resultContent').html(html);
                            $('#resultSection').show();
                        } else {
                            $('#resultContent').html(`
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i> ${response.message}
                                </div>
                            `);
                            $('#resultSection').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#loadingSpinner').hide();
                        $('#resultContent').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> An error occurred: ${error}
                            </div>
                        `);
                        $('#resultSection').show();
                    }
                });
            }

            // Function to show project modal
            function showProjectModal(projectName) {
                $('#projectDetailsModal').modal('show');
                $('#projectModalLoading').show();
                $('#projectModalContent').hide();
                $('#viewAllProjectCustomersLink').hide();

                $.ajax({
                    url: '@Url.Action("GetCustomersByProject", "SSQCustomers")',
                    type: 'GET',
                    data: { projectName: projectName },
                    success: function(response) {
                        $('#projectModalLoading').hide();

                        if (response.success) {
                            var html = `
                                <div class="text-center mb-4">
                                    <h3><i class="fas fa-building text-info"></i> ${response.projectName}</h3>
                                    <div class="display-4 text-info">${response.totalCustomers}</div>
                                    <p class="lead">Total Customers</p>
                                </div>
                            `;

                            if (response.sampleData && response.sampleData.length > 0) {
                                html += `
                                    <h5><i class="fas fa-list"></i> Recent Customers</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Customer No</th>
                                                    <th>Name</th>
                                                    <th>Block</th>
                                                    <th>Sector</th>
                                                    <th>Plot No</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                `;

                                response.sampleData.forEach(function(customer) {
                                    html += `
                                        <tr>
                                            <td>${customer.customerNo || 'N/A'}</td>
                                            <td>${customer.customerName || 'N/A'}</td>
                                            <td>${customer.block || 'N/A'}</td>
                                            <td>${customer.sector || 'N/A'}</td>
                                            <td>${customer.ploNo || 'N/A'}</td>
                                        </tr>
                                    `;
                                });

                                html += `
                                            </tbody>
                                        </table>
                                    </div>
                                    <p class="text-muted"><small>Showing first ${response.sampleData.length} customers</small></p>
                                `;
                            } else {
                                html += `
                                    <div class="alert alert-warning">
                                        <i class="fas fa-info-circle"></i> No customer data available for this project.
                                    </div>
                                `;
                            }

                            $('#projectModalContent').html(html);
                            $('#projectModalContent').show();

                            // Update the "View All Customers" link
                            $('#viewAllProjectCustomersLink')
                                .attr('href', '@Url.Action("Index", "SSQCustomers")?searchString=' + encodeURIComponent(response.projectName))
                                .show();
                        } else {
                            $('#projectModalContent').html(`
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i> ${response.message}
                                </div>
                            `);
                            $('#projectModalContent').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#projectModalLoading').hide();
                        $('#projectModalContent').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> An error occurred: ${error}
                            </div>
                        `);
                        $('#projectModalContent').show();
                    }
                });
            }

            // Function to show block modal with type information
                  // Function to show block modal with type information
        function showBlockModal(blockName) {
            $('#blockDetailsModal').modal('show');
            $('#blockModalLoading').show();
            $('#blockModalContent').hide();
            $('#viewAllBlockCustomersLink').hide();

            $.ajax({
                url: '@Url.Action("GetCustomersByBlock", "SSQCustomers")',
                type: 'GET',
                data: { blockName: blockName },
                success: function(response) {
                    $('#blockModalLoading').hide();

                    if (response.success) {
                        // Determine block type
                        var mohlanwalBlocks = @Html.Raw(Json.Serialize(ViewBag.MohlanwalBlocks ?? new List<string>()));
                        var orchardsBlocks = @Html.Raw(Json.Serialize(ViewBag.OrchardsBlocks ?? new List<string>()));
                        var isMohlanwal = mohlanwalBlocks && mohlanwalBlocks.includes(blockName);
                        var isOrchards = orchardsBlocks && orchardsBlocks.includes(blockName);

                        var blockType = "Unknown";
                        var badgeClass = "badge-secondary";
                        var icon = "fas fa-th-large";

                        if (isMohlanwal) {
                            blockType = "Mohlanwal";
                            badgeClass = "badge-info";
                            icon = "fas fa-cube";
                        } else if (isOrchards) {
                            blockType = "Orchards";
                            badgeClass = "badge-success";
                            icon = "fas fa-leaf";
                        }

                        var html = `
                            <div class="text-center mb-4">
                                <h3><i class="${icon} text-warning"></i> ${response.blockName}</h3>
                                <div>
                                    <span class="badge ${badgeClass}">${blockType}</span>
                                </div>
                                <div class="display-4 text-warning mt-2">${response.totalCustomers}</div>
                                <p class="lead">Total Customers</p>
                            </div>
                        `;

                        // Show breakdown by project
                        if (response.breakdownByProject && response.breakdownByProject.length > 0) {
                            html += `
                                <h5><i class="fas fa-building"></i> Projects in this Block</h5>
                                <div class="row mb-3">
                            `;

                            response.breakdownByProject.forEach(function(project) {
                                var percentage = (project.customerCount * 100 / response.totalCustomers).toFixed(1);
                                html += `
                                    <div class="col-md-6 mb-2">
                                        <div class="card">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>${project.projectName || 'N/A'}</span>
                                                    <span class="badge badge-primary">${project.customerCount} (${percentage}%)</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });

                            html += `</div>`;
                        }

                        if (response.sampleData && response.sampleData.length > 0) {
                            html += `
                                <h5><i class="fas fa-list"></i> Recent Customers</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Customer No</th>
                                                <th>Name</th>
                                                <th>Project</th>
                                                <th>Sector</th>
                                                <th>Plot No</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;

                            response.sampleData.forEach(function(customer) {
                                html += `
                                    <tr>
                                        <td>${customer.customerNo || 'N/A'}</td>
                                        <td>${customer.customerName || 'N/A'}</td>
                                        <td>${customer.project || 'N/A'}</td>
                                        <td>${customer.sector || 'N/A'}</td>
                                        <td>${customer.ploNo || 'N/A'}</td>
                                    </tr>
                                `;
                            });

                            html += `
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-muted"><small>Showing first ${response.sampleData.length} customers</small></p>
                            `;
                        } else {
                            html += `
                                <div class="alert alert-warning">
                                    <i class="fas fa-info-circle"></i> No customer data available for this block.
                                </div>
                            `;
                        }

                        $('#blockModalContent').html(html);
                        $('#blockModalContent').show();

                        // Update the "View All Customers" link
                        $('#viewAllBlockCustomersLink')
                            .attr('href', '@Url.Action("Index", "SSQCustomers")?searchString=' + encodeURIComponent(response.blockName))
                            .show();
                    } else {
                        $('#blockModalContent').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> ${response.message}
                            </div>
                        `);
                        $('#blockModalContent').show();
                    }
                },
                error: function(xhr, status, error) {
                    $('#blockModalLoading').hide();
                    $('#blockModalContent').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> An error occurred: ${error}
                        </div>
                    `);
                    $('#blockModalContent').show();
                }
            });
        }






            // Initialize DataTable for projects table
            $('#projectsTable').DataTable({
                "paging": false,
                "searching": false,
                "info": false,
                "ordering": true,
                "autoWidth": false,
                "responsive": true
            });

            // Initialize DataTable for blocks table
            $('#blocksTable').DataTable({
                "paging": false,
                "searching": false,
                "info": false,
                "ordering": true,
                "autoWidth": false,
                "responsive": true
            });
        });
    </script>
}